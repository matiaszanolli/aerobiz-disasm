# Engineer Findings -- B-056 Cross-Reference Index

## Script Design

**Script:** `tools/gen_call_graph.py`

### Approach

Single-pass line scanner over the 4 primary section files:
- `disasm/sections/section_000200.asm`
- `disasm/sections/section_010000.asm`
- `disasm/sections/section_020000.asm`
- `disasm/sections/section_030000.asm`

**Label tracking:** A "current function" variable is updated whenever a global label is seen. Global labels match `^[A-Za-z][A-Za-z0-9_]*:` at column 0. Auto-generated labels (`l_XXXXXX`) are detected by `RE_AUTO_LABEL = re.compile(r'^l_[0-9A-Fa-f]+$')` and do NOT update the current function -- they fall within whichever named function precedes them in the source. Local labels (starting with `.`) never update the tracker.

**Call patterns matched (4 regexes):**
1. `jsr FunctionName` -- abs.l calls (B-049 symbolized)
2. `jsr (FunctionName,PC)` -- PC-relative calls (B-050 symbolized)
3. `bsr.w FunctionName` -- BSR.W calls (B-051 symbolized)
4. `bsr.s FunctionName` -- BSR.S calls (2 found in section_030000)

**Output sections in CALL_GRAPH.md:**
1. Statistics summary
2. Top-20 most-called table
3. Leaf functions table (functions making no symbolic calls)
4. Root functions table (functions with no symbolic callers)
5. Full cross-reference: every callee alphabetically with full caller list and per-caller counts

### Label Count Reconciliation

- Raw global label lines in the 4 sections: 3,451 (761 + 766 + 852 + 1,072)
- `l_XXXXXX` auto-generated labels: 2,559
- Named function labels (892): 3,451 - 2,559 = 892
- FUNCTION_REFERENCE.md lists 595 "named" functions -- the difference (892 - 595 = 297) represents alt-entry labels, anonymous handler labels (e.g., `CmdTestVRAM_WithA3`), and sub-labels that are distinct from the primary 595 function set.

### Call Count vs FUNCTION_REFERENCE

FUNCTION_REFERENCE.md states: "2,869 jsr abs.l + 490 jsr (d16,PC) + 332 bsr.w = 3,691 total"

Actual counts in current source:
- jsr abs.l: 2,869 (unchanged)
- jsr (d16,PC): 490 (unchanged)
- bsr.w: 337 (not 332)
- bsr.s: 2 (not counted in FUNCTION_REFERENCE)
- **Total: 3,698**

The +7 discrepancy in bsr.w is because 7 additional bsr.w calls were added after the FUNCTION_REFERENCE was written (B-051 wave or subsequent work). The 3,698 count from the script is the accurate current figure.

## Output Sample (first 50 lines of CALL_GRAPH.md)

```
# Call Graph -- Aerobiz Supersonic

Auto-generated by `tools/gen_call_graph.py`.

## Statistics

- **Functions with labels in source:** 892
- **Unique callees (symbolic):** 605
- **Total call sites:** 3698
- **Leaf functions (no outgoing calls):** 366
- **Root functions (no incoming calls):** 287

## Top 20 Most-Called Functions

| Rank | Callee | Total Calls | Unique Callers |
|------|--------|-------------|----------------|
| 1 | GameCommand | 226 | 126 |
| 2 | sprintf | 130 | 55 |
| 3 | SetTextCursor | 123 | 46 |
| 4 | Multiply32 | 118 | 50 |
| 5 | SetTextWindow | 103 | 70 |
| 6 | SignedDiv | 98 | 51 |
| 7 | LZ_Decompress | 86 | 54 |
| 8 | RangeLookup | 84 | 58 |
| 9 | TilePlacement | 84 | 44 |
| 10 | ResourceUnload | 79 | 60 |
| 11 | ResourceLoad | 78 | 56 |
| 12 | ReadInput | 75 | 38 |
| 13 | PrintfWide | 73 | 39 |
| 14 | DisplaySetup | 71 | 52 |
| 15 | PollAction | 61 | 40 |
| 16 | GameCmd16 | 58 | 32 |
| 17 | MemFillByte | 58 | 44 |
| 18 | SignedMod | 57 | 34 |
| 19 | PrintfNarrow | 56 | 27 |
| 20 | RandRange | 55 | 31 |
```

Note on call count differences vs FUNCTION_REFERENCE "Most-Called" table:
- GameCommand: 226 (script) vs 306 (FUNCTION_REFERENCE). The FUNCTION_REFERENCE figure of 306 includes calls that are still dc.w (e.g., `dc.w $4eb9,$0000,$0d64` with comment). The script only counts symbolized mnemonics. The 80-call gap means ~80 GameCommand calls in section_010000 remain as dc.w.
- Multiply32: 118 (script) vs 204 (FUNCTION_REFERENCE). Similar explanation -- many calls to Multiply32 ($03E05C) in section_010000 remain as dc.w.

This is expected behavior: the script accurately counts symbolized calls; the FUNCTION_REFERENCE counted all call targets by ROM address scanning.

## Spot Checks

### GameCommand callers (top-called, 226 calls, 126 unique callers)

Full caller list from CALL_GRAPH.md includes: AlignTextBlock, ApplyPaletteShifts (2x),
BuildSpriteBuffer, CalcCharScoreS2, CalcCharacterBonus (2x), CalcOptimalTicketPrice (2x),
CalcScalar, CalcScrollBarPos, ClearDisplayBuffers (2x), ClearSoundBuffer (2x),
CmdPlaceTile, CmdPlaceTile2, CmdSetBackground, CompareCharCode, ComputeDisplayAttrsLower,
ComputeDisplayAttrsUpper, CopyWithMultiply, DelayFrames, DelayWithInputCheck,
DisplayPlayerLeaderboard (2x), DisplayRouteInfo (2x), DisplayTileSetup,
DrawPlayerComparisonStats, DrawQuarterResultsScreen (12x), ErrorDisplay, and 100+ more.

DrawQuarterResultsScreen calls GameCommand 12 times -- the highest single-caller count.
This is consistent with that function rendering a full results screen with many VDP ops.

### Multiply32 callers (118 calls, 50 unique callers)

Full caller list confirmed: AcquireCharSlot (2x), AnalyzeRouteProfit (5x), CalcTradeGains (8x),
ProcessCharJoin (8x), RenderAnimFrame (13x), FadeGraphics (4x), FilterCollection (4x),
and 43 other callers. RenderAnimFrame is the heaviest user at 13 calls.

### Leaf functions (366 total)

Spot-checked: BitFieldSearch (40 callers, leaf) -- correct, it's a pure algorithm.
GameCommand itself is a leaf for call-graph purposes (it dispatches via jump table, not symbolic calls).
Interrupt vectors (BusError, AddressError) appear as leaf+root -- correct, they're trap handlers.

### Root functions (287 total)

These 287 functions have no symbolic callers. They include:
- Interrupt/exception handlers (BusError, AddressError)
- Entry point functions called from dc.w blocks not yet symbolized
- Functions called only via jump tables or indirect JMP
- Functions in section_010000 where many callers remain as dc.w

## Recommendation

APPROVED for commit. The script is correct and the output is complete.

**Key findings from the generated graph:**
1. The 7,415-line CALL_GRAPH.md covers all 605 unique symbolic callees.
2. The 287 root functions with no symbolic callers are the best candidates for Phase 5
   work: verify whether they're called from dc.w blocks or jump tables. Many are likely
   called from section_010000 where dc.w call blocks remain.
3. The 366 leaf functions indicate functions operating entirely via hardware registers,
   memory operations, or indirect dispatch -- no further call resolution needed for them.
4. FUNCTION_REFERENCE.md should be updated: the "Call instructions symbolized" stat
   should read 3,698 (not 3,691) to reflect the 7 additional bsr.w calls added since
   B-051 was documented.

**Files produced:**
- `tools/gen_call_graph.py` -- generator script
- `analysis/CALL_GRAPH.md` -- 7,415-line cross-reference document
